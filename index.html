<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Khola Pata | Rural Land Exchange</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --green:#2e7d32;
  --brown:#8d4b20;
  --bg:#f7f7f4;
}
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:Inter,sans-serif;
  background:var(--bg)
}

/* HEADER */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  background:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.08)
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:44px;height:44px;border-radius:10px;
  background:linear-gradient(135deg,var(--green),var(--brown));
  color:#fff;font-family:"Baloo 2";
  display:flex;align-items:center;justify-content:center;
  font-weight:800
}
.controls input{
  padding:8px;border-radius:6px;border:1px solid #ccc;width:120px
}
button{
  padding:8px 12px;border:none;border-radius:6px;
  background:var(--green);color:#fff;
  font-weight:600;cursor:pointer
}

/* LAYOUT */
main{display:flex;height:calc(100% - 72px)}
.sidebar{
  width:340px;background:#fff;
  padding:12px;overflow:auto;
  border-right:1px solid #ddd
}
.mapwrap{flex:1}
#map{height:100%;width:100%}

/* CARD */
.card{
  background:#fff;
  padding:10px;border-radius:8px;
  margin-bottom:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.06)
}

/* MODAL */
.modal-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:flex;align-items:center;justify-content:center
}
.modal{
  background:#fff;padding:16px;
  border-radius:10px;width:320px
}

/* FOOTER LINKS */
.quick-links{
  font-size:13px;margin-top:10px
}
.quick-links a{
  color:var(--green);
  text-decoration:none;
  display:block;margin-top:6px
}

/* MOBILE */
@media(max-width:800px){
  main{flex-direction:column}
  .sidebar{width:100%;height:260px}
}
</style>
</head>

<body>

<header>
  <div class="brand">
    <div class="logo">KP</div>
    <div>
      <div style="font-weight:700">Khola Pata</div>
      <div style="font-size:12px;color:#555">
        Dalal-Verified Rural Land Exchange
      </div>
    </div>
  </div>
  <div class="controls">
    <input id="pinInput" placeholder="Enter PIN">
    <button onclick="openPin()">Search</button>
    <button onclick="useMyLocation()">üìç</button>
  </div>
</header>

<main>
  <div class="sidebar">
    <h3>Available Lands</h3>
    <div id="list"></div>

    <p style="font-size:13px;color:#555">
      ‚úî Verified by local agents<br>
      ‚úñ Direct seller contact not allowed
    </p>

    <div class="quick-links">
      <b>For Operators</b>
      <a href="dalal-onboard.html">üßë‚Äçüåæ Dalal Registration</a>
      <a href="admin.html">üõ°Ô∏è Admin Dashboard</a>
      <a href="blockchain.html">üîó Blockchain Proof</a>
    </div>
  </div>

  <div class="mapwrap">
    <div id="map"></div>
  </div>
</main>

<div id="modal"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   SAMPLE APPROVED LAND DATA
   (Dalal-verified only)
   ========================= */
const data = {
  "721154":[
    {
      id:"KP72115401",
      title:"Residential plot near market",
      lat:22.4215,
      lng:87.3221,
      price:"4.5 Lakh",
      dalal:{ id:"DL001", name:"Verified Local Agent" },
      status:"approved"
    },
    {
      id:"KP72115402",
      title:"Farm land near canal",
      lat:22.4182,
      lng:87.3284,
      price:"2 Lakh / acre",
      dalal:{ id:"DL001", name:"Verified Local Agent" },
      status:"approved"
    }
  ]
};

/* =========================
   MAP INIT
   ========================= */
const map = L.map("map").setView([23.5,87.5],7);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let markers=[];

/* =========================
   PIN SEARCH
   ========================= */
function openPin(){
  const pin=document.getElementById("pinInput").value.trim();
  showLands(data[pin] || []);
}

/* =========================
   CURRENT LOCATION SEARCH
   ========================= */
function useMyLocation(){
  if(!navigator.geolocation){
    alert("Location not supported");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;
    map.setView([lat,lng],14);
    showNearby(lat,lng,5);
  });
}

/* =========================
   RENDER LANDS
   ========================= */
function showLands(lands){
  clearMap();
  const list=document.getElementById("list");
  list.innerHTML="";

  if(!lands.length){
    list.innerHTML="<p>No approved land found.</p>";
    return;
  }

  lands.forEach(p=>{
    const m=L.marker([p.lat,p.lng]).addTo(map);
    m.bindPopup(`
      <b>${p.title}</b><br>
      Price: ‚Çπ ${p.price}<br>
      Handled by: ${p.dalal.name}<br><br>
      <button onclick="initiateDeal('${p.id}')">
        Contact Local Agent
      </button>
    `);
    markers.push(m);

    list.innerHTML+=`
      <div class="card">
        <b>${p.title}</b><br>
        ‚Çπ ${p.price}<br>
        <small>Via local verified agent</small>
      </div>`;
  });

  map.setView([lands[0].lat,lands[0].lng],13);
}

/* =========================
   NEARBY SEARCH
   ========================= */
function showNearby(lat,lng,radius){
  const found=[];
  Object.values(data).flat().forEach(p=>{
    if(distance(lat,lng,p.lat,p.lng)<=radius){
      found.push(p);
    }
  });
  showLands(found);
}

/* =========================
   DEAL FLOW (BUYER ‚Üí DALAL)
   ========================= */
function initiateDeal(landId){
  document.getElementById("modal").innerHTML=`
    <div class="modal-bg">
      <div class="modal">
        <h3>Proceed via Local Agent</h3>
        <p>
          Booking amount required.<br>
          Agent will coordinate visit & documents.
        </p>
        <button onclick="confirmBooking('${landId}')">
          Continue
        </button>
        <br><br>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
}

function confirmBooking(landId){
  document.getElementById("modal").innerHTML=`
    <div class="modal-bg">
      <div class="modal">
        <h3>Booking Recorded</h3>
        <p>
          Booking ID: <b>${landId}</b><br>
          Local agent will contact you.
        </p>
        <p style="font-size:12px;color:#555">
          Deal proof can be verified via blockchain log.
        </p>
        <button onclick="closeModal()">Done</button>
      </div>
    </div>`;
}

function closeModal(){
  document.getElementById("modal").innerHTML="";
}

/* =========================
   HELPERS
   ========================= */
function clearMap(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
}
function distance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=
    Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*
    Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>

</body>
</html>